import { Callout } from "nextra/components"
import { Code } from "@/components/Code"
import { Accordion, Accordions } from "@/components/Accordion"

<a href="https://orm.remult.team">
  <img align="right" src="/img/adapters/remult.svg" width="64" height="64" />
</a>

# Remult Adapter

## Resources

- [Remult documentation](https://remult.dev)

## Setup

### Installation

```bash npm2yarn
npm install remult @auth/remult-adapter
```

### Adapter Setup

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { JsonFileDataProvider } from "remult/server"
import { RemultAdapter } from "@auth/remult-adapter"

// any remult data provider
// postgres, mysql, mongodb, sqlite, mssql, oracle, json files, in memory...
const dataProvider = new JsonFileDataProvider("db")
const { adapter } = RemultAdapter({ dataProvider })

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter,
  providers: [],
})
```

</Code.Next>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { JsonFileDataProvider } from "remult/server"
import { RemultAdapter } from "@auth/remult-adapter"

// any remult data provider
// postgres, mysql, mongodb, sqlite, mssql, oracle, json files, in memory...
const dataProvider = new JsonFileDataProvider("db")
const { adapter } = RemultAdapter({ dataProvider })

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter,
  providers: [],
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { JsonFileDataProvider } from "remult/server"
import { RemultAdapter } from "@auth/remult-adapter"

// any remult data provider
// postgres, mysql, mongodb, sqlite, mssql, oracle, json files, in memory...
const dataProvider = new JsonFileDataProvider("db")
const { adapter } = RemultAdapter({ dataProvider })

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    adapter,
    providers: [],
  })
)
```

</Code.Express>
</Code>

#### Using your own Entities

If you want to add some fields in some entities, you can override default ones.

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { JsonFileDataProvider } from "remult/server"
import { RemultAdapter } from "@auth/remult-adapter"
import { User } from "../src/entities"

export class AppUser extends User {
  @Fields.string()
  jobTitle = ""
}

const dataProvider = new JsonFileDataProvider("db")
const { adapter } = RemultAdapter({
  dataProvider,
  customEntities: {
    User: AppUser,
    // Account: ...
    // Session: ...
    // Authenticator: ...
  },
})

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter,
  providers: [],
})
```

### Using `remult.user` in your app

<Code>
<Code.Next>
You can see a full example [here](https://github.com/noam-honig/dev-next-auth/blob/main/next).
</Code.Next>
<Code.Svelte>

First, fill the `getUser` function in your remult api.

```ts filename="./src/routes/api/[...remult]/+server.ts" {6-9}
import { remultSveltekit } from "remult/remult-sveltekit"
import { AuthController } from "../../../shared/AuthController"
import type { UserInfo } from "remult"

export const _api = remultSveltekit({
  getUser: async (events) => {
    const session = await events.locals.auth()
    return session?.user as UserInfo
  },
  entities: [],
  controllers: [AuthController],
})

export const { GET, POST, PUT, DELETE } = _api
```

Second, tweak your `hooks.server.ts` to use `withRemult` after `Auth.js`

```ts filename="./src/hooks.server.ts"
import { sequence } from "@sveltejs/kit/hooks"

import { handle as handleAuth } from "./auth"
import type { Handle } from "@sveltejs/kit"
import { _api } from "./routes/api/[...remult]/+server"

export const handleRemult: Handle = async ({ event, resolve }) => {
  return await _api.withRemult(event, async () => {
    return resolve(event)
  })
}

export const handle = sequence(handleAuth, handleRemult)
```

Third, make `remult.user` available everywhere

```ts filename="./src/routes/+layout.server.ts"
import type { LayoutServerLoad } from "./$types"

export const load = (async (event) => {
  const session = await event.locals.auth()
  return {
    remultUser: session?.user,
  }
}) satisfies LayoutServerLoad
```

```svelte filename="sveltekit/src/routes/+page.svelte"
<script lang="ts">
  import { remult } from "remult"

  export let data
  $: remult.user = data.remultUser
</script>

<pre>{JSON.stringify(remult.user, null, 2)}</pre>
```

You can see a full example [here](https://github.com/noam-honig/dev-next-auth/blob/main/sveltekit).

</Code.Svelte>
<Code.Express>
You can see a full example [here](https://github.com/noam-honig/dev-next-auth/blob/main/express).
</Code.Express>
</Code>
